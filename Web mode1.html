<!DOCTYPE html>
<html>

<head>
  <title>Test Agility Traning Game</title>
  <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
  <script
    src="https://unpkg.com/aframe-text-geometry-component@0.5.1/dist/aframe-text-geometry-component.min.js"></script>
</head>




<body>

  <a-scene a-frame-to-html>
    <a-assets>
      <img id="pink" src="https://img.gs/bbdkhfbzkk/stretch/http://i.imgur.com/1hyyIUi.jpg" crossorigin="anonymous" />
      <img src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" id="grid" crossorigin="anonymous">
      <img src="https://img.gs/bbdkhfbzkk/2048x1024,stretch/http://i.imgur.com/WMNH2OF.jpg" id="chrome"
        crossorigin="anonymous">
      <img id="sky" src="https://img.gs/bbdkhfbzkk/2048x2048,stretch/http://i.imgur.com/WqlqEkq.jpg"
        crossorigin="anonymous" />
      <a-asset-item id="dawningFont"
        src="https://cdn.glitch.com/c719c986-c0c5-48b8-967c-3cd8b8aa17f3%2FdawningOfANewDayRegular.typeface.json?1490305922844">
      </a-asset-item>
      <a-asset-item id="exoFont"
        src="https://cdn.glitch.com/c719c986-c0c5-48b8-967c-3cd8b8aa17f3%2Fexo2Black.typeface.json?1490305922150">
      </a-asset-item>
      <a-asset-item id="exoItalicFont"
        src="https://cdn.glitch.com/c719c986-c0c5-48b8-967c-3cd8b8aa17f3%2Fexo2BlackItalic.typeface.json?1490305922725">
      </a-asset-item>
      <img id="ocean" src="http://wicomcloud.dsmynas.com:3999/teach/water.jpg">
      <audio id="music"
        src="https://cdn.glitch.com/1d1902e8-d0df-4456-80aa-af540491c96a%2FAlternate.mp3?1558448882951"></audio>
      <audio id="music2"
        src="https://cdn.glitch.com/1d1902e8-d0df-4456-80aa-af540491c96a%2Fglaxymusic.mp3?1558448863255"></audio>
      <audio id="click"
        src="https://cdn.glitch.com/1d1902e8-d0df-4456-80aa-af540491c96a%2Fcoin08.mp3?1558448859528"></audio>
      <audio id="stage_sound"
        src="https://cdn.glitch.com/1d1902e8-d0df-4456-80aa-af540491c96a%2Fpowerup05.mp3?1558448860113"></audio>
      <audio id="change_sound"
        src="https://cdn.glitch.com/1d1902e8-d0df-4456-80aa-af540491c96a%2Fchange.mp3?1558448859541"></audio>
    </a-assets>


    <a-entity camera="userHeight:30" look-controls cursor="rayOrigin: mouse">


      <a-entity id="display" position="0 1 -6" rotation="5 0 0">

        <a-entity id="timeLeft" rotation="0 0 3" position="-4 5 0"
          text-geometry="value:Time left : 10; font: #exoFont; bevelEnabled: true; bevelSize: 0.05; bevelThickness: 0.05; curveSegments: 12; size: 1; height: 0;"
          material="color:lavenderblush; metalness:1; roughness: 0; sphericalEnvMap: #pink;"></a-entity>

        <a-entity id="stage" rotation="0 0 3" position="-3 6.7 0"
          text-geometry="value:Stage: 1; font: #exoFont; bevelEnabled: true; bevelSize: 0.05; bevelThickness: 0.05; curveSegments: 12; size: 1; height: 0;"
          material="color:lavenderblush; metalness:1; roughness: 0; sphericalEnvMap: #pink;"></a-entity>

        <a-entity id="rk" rotation="0 180 2" position="7 8 15"
          text-geometry="value:Thanks For Playing; font: #exoFont; bevelEnabled: true; bevelSize: 0.05; bevelThickness: 0.05; curveSegments: 12; size: 1; height: 0;"
          material="color:lavenderblush; metalness:1; roughness: 0; sphericalEnvMap: #pink;"></a-entity>

        <a-entity geometry="primitive: plane; width: 100; height: 100;" rotation="-90 0 0"
          material="src: #grid; repeat: 100 100; transparent: true;metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;">
        </a-entity>

        <a-entity light="color: ffaaff; intensity: 5" position="0 10 0"></a-entity>
        <a-entity light="color: white; type: ambient;"></a-entity>


        <a-icosahedron id="obj1" color="#D4C1EE" radius="2" position="-10 0 -50" rotation="0 360 0" scale="0.5 0.5 0.5">
          <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" easing="linear" dur="2400"></a-animation>
          <a-animation class="speed" attribute="position" to="-2 1 7" repeat="indefinite" easing="linear" dur="8000">
          </a-animation>
          <a-animation class="speed" attribute="position" from="-2 1 7" to="-10 0 -50" repeat="indefinite"
            easing="linear" dur="8000" delay="8000"></a-animation>
        </a-icosahedron>

        <a-icosahedron id="obj2" color="#DDA8F5" radius="2" position="0 1 7" rotation="0 360 0" scale="0.5 0.5 0.5">
          <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" easing="linear" dur="2400"></a-animation>
          <a-animation class="speed2" attribute="position" from="0 1 7" to="0 0 -50" dir="alternate" repeat="indefinite"
            easing="linear" dur="8000"></a-animation>
        </a-icosahedron>

        <a-icosahedron id="obj3" color="#FA86FF" radius="2" position="10 0 -50" rotation="0 360 0" scale="0.5 0.5 0.5">
          <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" easing="linear" dur="2400"></a-animation>
          <a-animation class="speed3" attribute="position" to="2 1 7" repeat="indefinite" easing="linear" dur="8000">
          </a-animation>
          <a-animation class="speed3" attribute="position" from="2 1 7" to="10 0 -50" repeat="indefinite"
            easing="linear" dur="8000" delay="8000"></a-animation>
        </a-icosahedron>

        <!-- 換音樂 -->
        <a-icosahedron id="obj4" color="#ff4d4d" radius="1" position="5 2 15" rotation="0 360 0" scale="0.5 0.5 0.5">
          <a-animation attribute="rotation" to="0 0 360" repeat="indefinite" easing="linear" dur="4800"></a-animation>
        </a-icosahedron>

        <!-- 換球的數量 -->
        <a-icosahedron id="obj5" color="#ff5c33" radius="1" position="0 2 15" rotation="0 360 0" scale="0.5 0.5 0.5">
          <a-animation attribute="rotation" to="0 0 360" repeat="indefinite" easing="linear" dur="4800"></a-animation>
        </a-icosahedron>

        <a-icosahedron id="obj6" color="#d633ff" radius="2" position="-5 1 -10" rotation="0 360 0" scale="0.5 0.5 0.5"
          visible="false">
          <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" easing="linear" dur="2400"></a-animation>
          <a-animation class="speed6" attribute="position" from="-5 1 -10" to="-30 1 -10" dir="alternate"
            repeat="indefinite" easing="linear" dur="8000"></a-animation>
        </a-icosahedron>

        <a-icosahedron id="obj7" color="#d633ff" radius="2" position="5 1 -10" rotation="0 360 0" scale="0.5 0.5 0.5"
          visible="false">
          <a-animation attribute="rotation" to="0 0 0" repeat="indefinite" easing="linear" dur="2400"></a-animation>
          <a-animation class="speed7" attribute="position" from="5 1 -10" to="30 1 -10" dir="alternate"
            repeat="indefinite" easing="linear" dur="8000"></a-animation>
        </a-icosahedron>

        <a-icosahedron id="restart" color="#ff5c33" radius="1" position="0 4 0" rotation="0 360 0" scale="0.5 0.5 0.5"
          visible="false">
          <a-animation attribute="rotation" to="0 0 360" repeat="indefinite" easing="linear" dur="4800"></a-animation>
        </a-icosahedron>

        <a-entity id="clicksound" position="0 5 0" sound="src: #click; autoplay: false; volume: 4;"></a-entity>
        <a-entity id="stagesound" position="0 5 0" sound="src: #stage_sound; autoplay: false; volume: 3;"></a-entity>
        <a-entity id="changesound" position="0 5 0" sound="src: #change_sound; autoplay: false; volume: 3;"></a-entity>
        <a-entity id="bgm" position="0 5 0" sound="src: #music; autoplay: true; volume: 5;loop: true;"></a-entity>

      </a-entity>

      <a-sky src="#sky" rotation="0 -90 0"></a-sky>
      <a-camera id="acamera" position="0 5 0"></a-camera>

    </a-entity>

  </a-scene>

</body>
<script>
  var time = 10; //每關剩餘時間
  var count = 3; //場上球的數量
  var stagenum = 1; //第幾關
  var bgmcontrol = 0; //控制背景音樂
  var speedvalue = 8000; //控制球的速度
  var mode = 0;
  var Visible1 = true;
  var Visible2 = true;
  var Visible3 = true;
  var Visible6 = false;
  var Visible7 = false;
  var Visiblere = false;
  var scene = document.querySelector('a-scene');
  var BGM = scene.querySelector('#bgm');
  var box1 = document.getElementById('obj1');
  var box2 = document.getElementById('obj2');
  var box3 = document.getElementById('obj3');
  var box4 = document.getElementById('obj4');
  var box6 = document.getElementById('obj6');
  var box7 = document.getElementById('obj7');
  var boxre = document.getElementById('restart');
  var stage = document.getElementById('stage');
  var speed = scene.querySelectorAll('.speed');
  var speed2 = scene.querySelectorAll('.speed2');
  var speed3 = scene.querySelectorAll('.speed3')
  var speed6 = scene.querySelectorAll('.speed6');
  var speed7 = scene.querySelectorAll('.speed7');
  var Csound = document.querySelector('[sound]');//抓點擊時音效的物件
  var Stagesound = document.querySelector('#stagesound');//抓進入下一關時音效的物件
  var changesound = document.querySelector('#changesound');//抓進入下一關時音效的物件
  var timeObj = document.getElementById("timeLeft");
  var rankName = [];
  var rankNum = [];
  var tag = 0;
  var message = "; font: #exoItalicFont; bevelEnabled: true; bevelSize: 0.05; bevelThickness: 0.05; curveSegments: 12; size: 1; height: 0;";

  AFRAME.registerComponent('a-frame-to-html', {
    init: function () {

      if (localStorage.length) {
        for (var i = 0; i < localStorage.length; i++) {
          if (localStorage.key(i).startsWith("ball2-")) {
            rankName[tag] = localStorage.key(i);
            rankNum[tag] = localStorage.getItem(rankName[tag]);
            tag++
          }
        }
      }

      Csound.components.sound.stopSound();
      countTime();

      el = this.el;

      this.el.addEventListener('click', (e) => {
        if (e.srcElement.id == 'obj1') {
          if (Visible1) {
            count--;
            box1.setAttribute("visible", "false");
            Csound.components.sound.stopSound();
            Csound.components.sound.playSound();
          }

          Visible1 = false;
          console.log(count);
        }
        else if (e.srcElement.id == 'obj2') {
          if (Visible2) {
            count--;
            box2.setAttribute("visible", "false");
            Csound.components.sound.stopSound();
            Csound.components.sound.playSound();
          }

          Visible2 = false;
          console.log(count);
        }
        else if (e.srcElement.id == 'obj3') {
          if (Visible3) {
            count--;
            box3.setAttribute("visible", "false");
            Csound.components.sound.stopSound();
            Csound.components.sound.playSound();
          }

          Visible3 = false;
          console.log(count);
        }
        else if (e.srcElement.id == 'obj6') {
          if (Visible6) {
            count--;
            box6.setAttribute("visible", "false");
            Csound.components.sound.stopSound();
            Csound.components.sound.playSound();
          }

          Visible6 = false;
          console.log(count);
        }
        else if (e.srcElement.id == 'obj7') {
          if (Visible7) {
            count--;
            box7.setAttribute("visible", "false");
            Csound.components.sound.stopSound();
            Csound.components.sound.playSound();
          }

          Visible7 = false;
          console.log(count);
        }
        else if (e.srcElement.id == 'restart') {
          if (Visiblere) {
            boxre.setAttribute("visible", "false");
            restart();
          }

        }
        else if (e.srcElement.id == 'obj4') {
          if (bgmcontrol == 0) {
            bgmcontrol = 1;
            changesound.components.sound.stopSound();
            changesound.components.sound.playSound();
            BGM.setAttribute("sound", "src: #music2; autoplay: true; volume: 7;loop: true;");
          }
          else {
            bgmcontrol = 0;
            changesound.components.sound.stopSound();
            changesound.components.sound.playSound();
            BGM.setAttribute("sound", "src: #music; autoplay: true; volume: 5;loop: true;");
          }
        }
        else if (e.srcElement.id == 'obj5' && Visiblere == false) {
          if (mode == 0) {
            mode = 1;
            count = 5;
            stagenum = 1;
            speedvalue = 8000;
            time = 10;
            Visible1 = true;
            Visible2 = true;
            Visible3 = true;
            Visible6 = true;
            Visible7 = true;
            box1.setAttribute("visible", "true");
            box2.setAttribute("visible", "true");
            box3.setAttribute("visible", "true");
            box6.setAttribute("visible", "true");
            box7.setAttribute("visible", "true");
            changesound.components.sound.stopSound();
            changesound.components.sound.playSound();
            stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message);
            timeObj.setAttribute("text-geometry", "value:Time left :" + time + message);
          }
          else {
            mode = 0;
            count = 3;
            stagenum = 1;
            speedvalue = 8000;
            time = 10;
            Visible1 = true;
            Visible2 = true;
            Visible3 = true;
            Visible6 = false;
            Visible7 = false;
            box1.setAttribute("visible", "true");
            box2.setAttribute("visible", "true");
            box3.setAttribute("visible", "true");
            box6.setAttribute("visible", "false");
            box7.setAttribute("visible", "false");
            changesound.components.sound.stopSound();
            changesound.components.sound.playSound();
            stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message);
            timeObj.setAttribute("text-geometry", "value:Time left :" + time + message);
          }
        }
        if (count == 0) {
          if (mode == 0) {
            count = 3;
            stagenum++;
            nextStage();
            Stagesound.components.sound.stopSound();
            Stagesound.components.sound.playSound();
          }
          else {
            count = 5;
            stagenum++;
            nextStage2();
            Stagesound.components.sound.stopSound();
            Stagesound.components.sound.playSound();
          }
        }
      })
    }
  });

  var sub = 1500;

  function restart() {
    if (mode == 1) {
      count = 5;
      stagenum = 1;
      speedvalue = 8000;
      time = 10;
      Visible1 = true;
      Visible2 = true;
      Visible3 = true;
      Visible6 = true;
      Visible7 = true;
      box1.setAttribute("visible", "true");
      box2.setAttribute("visible", "true");
      box3.setAttribute("visible", "true");
      box6.setAttribute("visible", "true");
      box7.setAttribute("visible", "true");
      changesound.components.sound.stopSound();
      changesound.components.sound.playSound();
      stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message);
      timeObj.setAttribute("text-geometry", "value:Time left :" + time + message);
      nextStage2();
    }
    else {
      count = 3;
      stagenum = 1;
      speedvalue = 8000;
      time = 10;
      Visible1 = true;
      Visible2 = true;
      Visible3 = true;
      Visible6 = false;
      Visible7 = false;
      box1.setAttribute("visible", "true");
      box2.setAttribute("visible", "true");
      box3.setAttribute("visible", "true");
      box6.setAttribute("visible", "false");
      box7.setAttribute("visible", "false");
      changesound.components.sound.stopSound();
      changesound.components.sound.playSound();
      stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message);
      timeObj.setAttribute("text-geometry", "value:Time left :" + time + message);
      nextStage();
    }
  }

  function nextStage() {

    time = 10;

    if (speedvalue > 2000) {
      speedvalue -= sub;
      if (sub > 500) sub -= 200;
    }
    else if (speedvalue <= 2000 && speedvalue > 1000) {
      speedvalue -= 100;
    }
    else if (speedvalue <= 1000 && speedvalue > 100) {
      speedvalue -= 50;
    }
    else {
      speedvalue = 100;
    }

    console.log(speedvalue);
    stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message)
    speed[0].setAttribute("dur", speedvalue)
    speed[1].setAttribute("dur", speedvalue)
    speed[1].setAttribute("delay", speedvalue)
    speed2[0].setAttribute("dur", speedvalue)
    speed3[0].setAttribute("dur", speedvalue)
    speed3[1].setAttribute("dur", speedvalue)
    speed3[1].setAttribute("delay", speedvalue)

    window.setTimeout(stageInit, 500);
  }



  function nextStage2() {

    time = 10;

    if (speedvalue > 2000) {
      speedvalue -= sub;
      if (sub > 500) sub -= 200;
    }
    else if (speedvalue <= 2000 && speedvalue > 1000) {
      speedvalue -= 100;
    }
    else if (speedvalue <= 1000 && speedvalue > 100) {
      speedvalue -= 50;
    }
    else {
      speedvalue = 100;
    }

    console.log(speedvalue);
    stage.setAttribute("text-geometry", "value:Stage: " + stagenum + message)
    speed[0].setAttribute("dur", speedvalue)
    speed[1].setAttribute("dur", speedvalue)
    speed[1].setAttribute("delay", speedvalue)
    speed2[0].setAttribute("dur", speedvalue)
    speed3[0].setAttribute("dur", speedvalue)
    speed3[1].setAttribute("dur", speedvalue)
    speed3[1].setAttribute("delay", speedvalue)
    speed6[0].setAttribute("dur", speedvalue)
    speed7[0].setAttribute("dur", speedvalue)

    window.setTimeout(stageInit2, 500);
  }

  function stageInit() {

    box1.setAttribute("visible", "true");
    box2.setAttribute("visible", "true");
    box3.setAttribute("visible", "true");
    Visible1 = true;
    Visible2 = true;
    Visible3 = true;
  }

  function stageInit2() {

    box1.setAttribute("visible", "true");
    box2.setAttribute("visible", "true");
    box3.setAttribute("visible", "true");
    box6.setAttribute("visible", "true");
    box7.setAttribute("visible", "true");
    Visible1 = true;
    Visible2 = true;
    Visible3 = true;
    Visible6 = true;
    Visible7 = true;
  }

  function countTime() {

    var timeObj = document.getElementById("timeLeft");

    x = setInterval(changeTime, 1000);

    function changeTime() {
      if (time > 0) {
        time--;
        timeObj.setAttribute("text-geometry", "value:Time left :" + time + message);
        console.log(time);
      }
      else if(time == 0){
        timeObj.setAttribute("text-geometry", "value:Game Over" + message);
        timeObj.setAttribute("text-geometry", "value:Game Over" + message);
        time--;
        box1.setAttribute("visible", "false");
        box2.setAttribute("visible", "false");
        box3.setAttribute("visible", "false");
        box6.setAttribute("visible", "false");
        box7.setAttribute("visible", "false");
        Visible1 = false;
        Visible2 = false;
        Visible3 = false;
        Visible6 = false;
        Visible7 = false;
        Visiblere = true;
        boxre.setAttribute("visible", "true");
        end();
      }
    }
  }


  function show() {
    var mes = "";
    var rk = document.getElementById("rk");
    for (var i = 0; i < rankNum.length; i++) {
      mes += rankName[i].substr(6) + " : " + rankNum[i] + " stages\n";
    }

    rk.setAttribute("text-geometry", "value:     Rank\n" + mes);
  }


  function end() {

    t = stagenum;

    bubbleSort();

    if (rankNum.length < 3) {  //新的名次出來
      while (1) {
        var name = prompt("請輸入的名字(只能包含英文及數字):");
        var pattern = new RegExp("[A-Za-z0-9]+");
        if (pattern.test(name) && name) {
          break;
        }
        else {
          window.alert("要英文不要國語~ 2020/1/11 回家投票!!!!!");
        }
      }
      console.log("wwwww1")

      rankName[rankNum.length] = "ball2-" + name;
      rankNum[rankNum.length] = t;
      localStorage.setItem("ball2-" + name, t);
    }
    else {
      if (parseInt(rankNum[rankNum.length - 1]) < t) {
        localStorage.removeItem(rankName[rankNum.length - 1]);

        while (1) {
          var name = prompt("請輸入的名字(只能包含英文及數字):");
          var pattern = new RegExp("[A-Za-z0-9]+");
          if (pattern.test(name) && name) {
            break;
          }
          else {
            window.alert("要英文不要國語~ 2020/1/11 回家投票!!!!!");
          }
        }
        
        console.log("wwwww2")
        rankName[rankNum.length - 1] = "ball2-" + name;
        rankNum[rankNum.length - 1] = t;
        localStorage.setItem(rankName[rankNum.length - 1], t);

      }
    }

    bubbleSort();
    
    show();
  }

  function bubbleSort() {
    var len = rankNum.length;
    for (var i = 0; i < len; i++) {
      for (var j = 0; j < len - 1 - i; j++) {
        if (parseInt(rankNum[j]) < parseInt(rankNum[j + 1])) {  // 相鄰元素兩兩對比
          var temp = rankNum[j + 1];  // 元素交換
          rankNum[j + 1] = rankNum[j];
          rankNum[j] = temp;

          var temp2 = rankName[j + 1];  // 元素交換
          rankName[j + 1] = rankName[j];
          rankName[j] = temp2;

        }
      }
    }
  }

</script>

</html>